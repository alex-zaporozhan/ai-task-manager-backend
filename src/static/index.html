<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #4f46e5; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-900">

    <!-- Navbar -->
    <nav class="bg-white shadow fixed w-full z-10 top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <h1 class="text-2xl font-extrabold text-indigo-600 tracking-tight">üöÄ Enterprise AI</h1>
                    <div id="nav-links" class="hidden flex space-x-4">
                        <button onclick="switchTab('tasks')" id="nav-tasks" class="px-3 py-2 rounded-md text-sm font-medium bg-gray-100">–ó–∞–¥–∞—á–∏</button>
                        <button onclick="switchTab('team')" id="nav-team" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:bg-gray-50">–ö–æ–º–∞–Ω–¥–∞</button>
                    </div>
                </div>
                <div class="flex items-center">
                    <span id="user-email" class="mr-4 text-gray-600 text-sm font-medium hidden"></span>
                    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ Logout: –¥–æ–±–∞–≤–ª–µ–Ω onclick -->
                    <button id="btn-logout" onclick="logout()" class="hidden text-red-500 hover:text-red-700 text-sm font-semibold border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10">
        <!-- Auth Screen -->
        <div id="auth-screen" class="flex items-center justify-center h-[70vh]">
            <div class="bg-white p-10 rounded-2xl shadow-xl w-96 border border-gray-100">
                <h2 class="text-3xl font-bold text-gray-900 text-center mb-8">–í—Ö–æ–¥</h2>
                <form id="login-form" class="space-y-5">
                    <input type="email" id="email" class="block w-full rounded-lg border-gray-300 bg-gray-50 p-3 border" placeholder="Email" required>
                    <input type="password" id="password" class="block w-full rounded-lg border-gray-300 bg-gray-50 p-3 border" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold transition">–í–æ–π—Ç–∏</button>
                </form>
                <p id="login-error" class="mt-4 text-red-500 text-sm text-center hidden"></p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-screen" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">–ó–∞–¥–∞—á–∏</h2>
                <button onclick="openCreateModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-md flex items-center">
                    <span class="text-xl mr-2">+</span> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                </button>
            </div>
            <div id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Team Screen -->
        <div id="team-screen" class="hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-8">–ö–æ–º–∞–Ω–¥–∞</h2>
            <div id="team-list" class="space-y-8"></div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="create-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="create-task-form" class="space-y-4">
                <input type="text" id="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full p-3 border rounded-lg" required>
                <textarea id="task-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3" class="w-full p-3 border rounded-lg"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <select id="task-priority" class="w-full p-3 border rounded-lg bg-white">
                        <option value="medium">Medium</option>
                        <option value="high">High üî•</option>
                        <option value="critical">Critical üö®</option>
                    </select>

                    <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –ü–û–õ–ï –û–¢–î–ï–õ–ê -->
                    <div id="dept-selector-container">
                        <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –ª–∏–±–æ input disabled, –ª–∏–±–æ select -->
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8000";
        let token = localStorage.getItem("token");
        let currentUser = null;
        let allDepartments = [];

        // --- Auth & Init ---
        async function checkAuth() {
            if (token) {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å—Ä–∞–∑—É
                    const res = await fetch(`${API_URL}/auth/me`, { headers: { "Authorization": `Bearer ${token}` } });
                    if (!res.ok) throw new Error();
                    currentUser = await res.json();

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById("auth-screen").classList.add("hidden");
                    document.getElementById("nav-links").classList.remove("hidden");
                    document.getElementById("btn-logout").classList.remove("hidden");

                    const emailEl = document.getElementById("user-email");
                    emailEl.innerText = `${currentUser.full_name} (${currentUser.role})`;
                    emailEl.classList.remove("hidden");

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã (–Ω—É–∂–Ω—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ –≤ –º–æ–¥–∞–ª–∫–µ)
                    await fetchDepartments();

                    switchTab('tasks');
                } catch (e) {
                    logout();
                }
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById("auth-screen").classList.remove("hidden");
            document.getElementById("dashboard-screen").classList.add("hidden");
            document.getElementById("team-screen").classList.add("hidden");
            document.getElementById("nav-links").classList.add("hidden");
            document.getElementById("btn-logout").classList.add("hidden");
            document.getElementById("user-email").classList.add("hidden");
        }

        function logout() {
            localStorage.removeItem("token");
            token = null;
            currentUser = null;
            showLogin();
        }

        // --- Logic ---
        async function fetchDepartments() {
            try {
                const res = await fetch(`${API_URL}/departments/`, { headers: { "Authorization": `Bearer ${token}` } });
                if (res.ok) allDepartments = await res.json();
            } catch (e) { console.error(e); }
        }

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ (Admin vs Employee)
        function openCreateModal() {
            const container = document.getElementById("dept-selector-container");
            container.innerHTML = "";

            if (currentUser.role === 'admin') {
                // –ï—Å–ª–∏ –ê–¥–º–∏–Ω - –¥–∞–µ–º –≤—ã–±–æ—Ä –æ—Ç–¥–µ–ª–∞
                let options = allDepartments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                if (allDepartments.length === 0) options = `<option value="">–ù–µ—Ç –æ—Ç–¥–µ–ª–æ–≤</option>`;

                container.innerHTML = `
                    <select id="target-dept-id" class="w-full p-3 border rounded-lg bg-white">
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
                        ${options}
                    </select>`;
            } else {
                // –ï—Å–ª–∏ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–í–∞—à –æ—Ç–¥–µ–ª" –∏ —Å–∫—Ä—ã—Ç—ã–π ID
                // (–ë—ç–∫–µ–Ω–¥ —Å–∞–º –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –æ—Ç–¥–µ–ª, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—Ç—å ID, –Ω–æ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –ø–æ–∫–∞–∂–µ–º)
                container.innerHTML = `
                    <input type="text" disabled value="–ú–æ–π –æ—Ç–¥–µ–ª" class="w-full p-3 border rounded-lg bg-gray-100 text-gray-500">
                `;
            }
            document.getElementById("create-modal").classList.remove("hidden");
        }

        function closeCreateModal() {
            document.getElementById("create-modal").classList.add("hidden");
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        document.getElementById("create-task-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("task-title").value;
            const desc = document.getElementById("task-desc").value;
            const priority = document.getElementById("task-priority").value;

            let targetDeptId = null;
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–µ–ª–µ–∫—Ç (–ê–¥–º–∏–Ω), –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç—Ç—É–¥–∞
            const selectEl = document.getElementById("target-dept-id");
            if (selectEl) targetDeptId = selectEl.value;

            const payload = {
                title, description: desc, priority,
                deadline: "2030-01-01T12:00:00Z",
                target_dept_id: targetDeptId // –ú–æ–∂–µ—Ç –±—ã—Ç—å null, –±—ç–∫–µ–Ω–¥ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
            };

            const res = await fetch(`${API_URL}/tasks/`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                closeCreateModal();
                loadTasks();
            } else {
                alert("–û—à–∏–±–∫–∞! –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –ê–¥–º–∏–Ω –∏ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –æ—Ç–¥–µ–ª?");
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
        async function loadTasks() {
            const container = document.getElementById("task-list");
            container.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            const res = await fetch(`${API_URL}/tasks/`, { headers: { "Authorization": `Bearer ${token}` } });
            const tasks = await res.json();

            container.innerHTML = "";
            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-gray-500">–ù–µ—Ç –∑–∞–¥–∞—á</div>`;
                return;
            }

            tasks.forEach(task => {
                const card = document.createElement("div");
                card.className = "bg-white p-6 rounded-xl shadow-sm border border-gray-100";
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${task.title}</h3>
                    <p class="text-gray-600 text-sm mb-4">${task.description || ""}</p>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">${task.status}</span>
                        <button onclick="analyzeTask('${task.id}')" class="text-indigo-600 text-sm font-bold">‚ú® AI Analyze</button>
                    </div>
                    <div id="ai-result-${task.id}" class="hidden mt-3 p-3 bg-indigo-50 rounded text-sm text-gray-800"></div>
                `;
                container.appendChild(card);
            });
        }

        async function analyzeTask(id) {
            const box = document.getElementById(`ai-result-${id}`);
            box.classList.remove("hidden");
            box.innerText = "Thinking...";
            const res = await fetch(`${API_URL}/tasks/${id}/analyze`, { method: "POST", headers: { "Authorization": `Bearer ${token}` } });
            const data = await res.json();
            box.innerHTML = data.ai_advice.replace(/\n/g, '<br>');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            document.getElementById("dashboard-screen").classList.toggle("hidden", tab !== 'tasks');
            document.getElementById("team-screen").classList.toggle("hidden", tab !== 'team');
            if (tab === 'tasks') loadTasks();
            // if (tab === 'team') loadTeam(); // –¢—É—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –∫–æ–¥–∞
        }

        // Login Handler
        document.getElementById("login-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new URLSearchParams();
            formData.append("username", document.getElementById("email").value);
            formData.append("password", document.getElementById("password").value);

            const res = await fetch(`${API_URL}/auth/token`, { method: "POST", body: formData });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem("token", data.access_token);
                token = data.access_token;
                checkAuth();
            } else {
                document.getElementById("login-error").innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
                document.getElementById("login-error").classList.remove("hidden");
            }
        });

        checkAuth();
    </script>
</body>
</html>